
## 5. 扩展模式（Extension Model）

### 5.1. 概述

在JUnit 4中`Runner`, `@Rule` 和 `@ClassRule`扩展点相反，JUnit Jshiupiter扩展模式含一个单一的、一致的概念:`Extension API`。但是，请注意，`Extension`本身只是一个标记接口。

### 5.1. 注册扩展

可以通过[@ExtendWith](http://junit.org/junit5/docs/current/api/org/junit/jupiter/api/extension/ExtendWith.html)或通过Java的[`ServiceLoader`机制](http://junit.org/junit5/docs/current/user-guide/#extensions-registration-automatic)自动注册扩展。

5.2.1. 声明扩展注册

开发人员可以注册一个或多个扩展注释声明的一个测试界面,测试类,测试方法,或自定义注释（ [composed annotation](http://junit.org/junit5/docs/current/user-guide/#writing-tests-meta-annotations)）与`@ExtendWith(…)`,提供扩展注册类引用。

例如，要为一个特定的测试方法注册一个自定义的`MockitoExtension`，您将对测试方法进行注释，如下所示。

~~~
@ExtendWith(MockitoExtension.class)
@Test
void mockTest() {
    // ...
}
~~~

要在一个特定的类及其子类中为所有测试注册一个定制的`MockitoExtension`，您将对测试类进行注释，如下所示。

~~~
@ExtendWith(MockitoExtension.class)
class MockTests {
    // ...
}
~~~

多个扩展可以这样一起注册:

~~~
@ExtendWith({ FooExtension.class, BarExtension.class })
class MyTestsV1 {
    // ...
}
~~~

作为替代，多个扩展可以像这样分别注册:

~~~
@ExtendWith(FooExtension.class)
@ExtendWith(BarExtension.class)
class MyTestsV2 {
    // ...
}
~~~

`MyTestsV1`和`MyTestsV2`的测试的执行将由`FooExtension`和`BarExtension`进行扩展，按照这个顺序进行。

#### 5.2.2. 自动扩展注册

除了使用注释的声明扩展注册（[declarative extension registration](http://junit.org/junit5/docs/current/user-guide/#extensions-registration-declarative)）支持之外，JUnit Jupiter还通过Java的`java.util.ServiceLoader`机制支持全局扩展注册，允许第三方扩展根据类路径中可用的内容自动检测和注册。

特别地,一个定制的扩展可以通过提供注册文件的完全限定类名`org.junit.jupiter.api.extension`命名。扩展到`/META-INF/services`文件夹内的封闭JAR文件。

#### 启用自动扩展检测

自动检测是一个高级特性，因此在默认情况下是不启用的。要启用它,只需设置`junit.jupiter.extensions.autodetection`。使配置参数为`true`。可以作为一个JVM系统属性提供，作为`LauncherDiscoveryRequest`中传递给启动程序的配置参数，或者通过JUnit Platform配置文件(参见配置参数（[Configuration Parameters](http://junit.org/junit5/docs/current/user-guide/#running-tests-config-params）获取详细信息) ）。

例如，为了启用对扩展的自动检测，您可以使用以下系统属性启动JVM。

`-Djunit.jupiter.extensions.autodetection.enabled=true`

当启用自动检测时，通过`ServiceLoader`机制发现的扩展将在JUnit木星的全局扩展(例如，支持`TestInfo`、`TestReporter`等)之后添加到扩展注册表中。

#### 5.2.3. 扩展继承

通过自顶向下的语义，在测试类层次结构中继承了已注册的扩展。类似地，在类级注册的扩展在方法级继承。此外，一个特定的扩展实现只能在给定的扩展上下文和它的父上下文上注册一次。因此，任何注册重复扩展实现的尝试都将被忽略。

### 5.3. 有条件的执行测试

执行条件([`ExecutionCondition`](http://junit.org/junit5/docs/current/api/org/junit/jupiter/api/extension/ExecutionCondition.html))定义了可编程的、有条件的执行测试扩展(`Extension`)API。

一个`ExecutionCondition`对每个容器(例如，一个测试类)来确定它所包含的所有测试是否应该基于`ExtensionContext`所提供的内容进行执行。类似地，每个测试都要对一个执行条件进行评估，以确定是否应该基于提供的`ExtensionContext`来执行给定的测试方法。

当多个`ExecutionCondition`扩展被注册时，一旦一个条件返回被禁用，容器或测试就被禁用。因此，不能保证对一个条件进行`结果的评估`，因为另一个扩展可能已经导致了一个容器或测试被禁用。换句话说，`结果的评估`工作像对布尔或运算符进行短路处理。

具体示例参见[`DisabledCondition`](https://github.com/junit-team/junit5/tree/r5.0.2/junit-jupiter-engine/src/main/java/org/junit/jupiter/engine/extension/DisabledCondition.java)和[`@Disabled`](http://junit.org/junit5/docs/current/api/org/junit/jupiter/api/Disabled.html)的源代码。

#### 5.3.1. 失活条件（停用条件）
有时候，在没有特定条件的情况下运行测试套件是很有用的。例如，您可能希望运行测试，即使这些测试是用`@Disabled`的，以便查看它们是否仍然被破坏。为此,只需提供一个`junit.jupiter.conditions.deactivate`配置模式参数,应该停用(即指定条件。不评估)当前的测试运行。该模式可以作为一个JVM系统属性提供，作为`LauncherDiscoveryRequest`中传递给`Launcher`的配置参数，或者通过JUnit Platform配置文件(参见配置参数([Configuration Parameters](http://junit.org/junit5/docs/current/user-guide/#running-tests-config-params))获取详细信息)。

例如，要禁用JUnit的`@Disabled`条件，您可以使用以下系统属性启动JVM。

`-Djunit.jupiter.conditions.deactivate=org.junit.*DisabledCondition`

#### 模式匹配的语法(Pattern Matching Syntax)

如果`junit.jupiter.conditions.deactivate`模式由单纯的星号(*),所有条件将停用。否则，该模式将用于匹配每个注册条件的完全限定类名(FQCN)。模式中的任何点(.)将与FQCN中的点(.)或美元符号($)匹配。任何星号(*)将与FQCN中的一个或多个字符相匹配。模式中的所有其他字符将与FQCN匹配。

例子:

*: 会让所有条件都失活。
org.junit.*: 取消`org.junit`基础包及其任何子包的所有条件。
*.MyCondition: 使每个类名完全是`MyCondition`的条件失效。
*System*: 取消所有类名中包含`System`的条件。
org.example.MyCondition: 失活的条件，其FQCN完全是`org.example.MyCondition`。

### 5.4. 测试实例后处理

[`TestInstancePostProcessor`](http://junit.org/junit5/docs/current/api/org/junit/jupiter/api/extension/TestInstancePostProcessor.html)定义了用于发布流程测试实例的`Extensions`的API。

常见的用例包括将依赖注入到测试实例中，在测试实例上调用自定义的初始化方法等等。

对于具体的例子，请参考[`MockitoExtension`](https://github.com/junit-team/junit5-samples/tree/r5.0.2/junit5-mockito-extension/src/main/java/com/example/mockito/MockitoExtension.java)和[`SpringExtension`](https://github.com/spring-projects/spring-framework/tree/master/spring-test/src/main/java/org/springframework/test/context/junit/jupiter/SpringExtension.java)的源代码。

### 5.5. 参数解析
